package com.mbeddr.cpp.classes.behavior;

/*Generated by MPS */

import org.jetbrains.mps.openapi.model.SNode;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SNodeOperations;
import java.util.HashSet;
import jetbrains.mps.internal.collections.runtime.Sequence;
import java.util.Collections;
import java.util.Set;
import jetbrains.mps.internal.collections.runtime.ListSequence;
import jetbrains.mps.lang.smodel.generator.smodelAdapter.SLinkOperations;
import jetbrains.mps.internal.collections.runtime.IWhereFilter;

public class ConceptLocator {
  public static Iterable<SNode> getAvailableConcepts(SNode someNode) {
    return getConceptsAvailableInModule(SNodeOperations.getAncestor(someNode, "com.mbeddr.cpp.cext.structure.CppImplementationModule", false, false));
  }

  private static Iterable<SNode> getConceptsAvailableInModule(SNode module) {
    HashSet<SNode> inspectedModules = new HashSet();
    Iterable<SNode> discoveredConcepts = Sequence.fromIterable(Collections.<SNode>emptyList());

    discoveredConcepts = getConceptsRec(inspectedModules, module, discoveredConcepts);

    return discoveredConcepts;

  }

  /**
   * 
   * IT IS A CODE CLONE of ClassLocator!!!!!!!  Modify together
   * 
   * @param inspectedModules a
   * @param moduleToInspect b
   * @param discoveredConcepts c
   * @return d
   */
  private static Iterable<SNode> getConceptsRec(Set<SNode> inspectedModules, SNode moduleToInspect, Iterable<SNode> discoveredConcepts) {

    if (inspectedModules.contains(moduleToInspect)) {
      return discoveredConcepts;
    }


    discoveredConcepts = Sequence.fromIterable(discoveredConcepts).concat(ListSequence.fromList(SNodeOperations.getDescendants(moduleToInspect, "com.mbeddr.cpp.classes.structure.Concept", false, new String[]{})));


    for (SNode node_ModuleImport_ : ListSequence.fromList(SLinkOperations.getTargets(moduleToInspect, "imports", true)).where(new IWhereFilter<SNode>() {
      public boolean accept(SNode it) {
        return SNodeOperations.isInstanceOf(it, "com.mbeddr.core.modules.structure.ModuleImport");
      }
    })) {
      if (SNodeOperations.isInstanceOf(SLinkOperations.getTarget(node_ModuleImport_, "module", false), "com.mbeddr.cpp.cext.structure.CppImplementationModule")) {

        discoveredConcepts = getConceptsRec(inspectedModules, SNodeOperations.as(SLinkOperations.getTarget(node_ModuleImport_, "module", false), "com.mbeddr.cpp.cext.structure.CppImplementationModule"), discoveredConcepts);
        inspectedModules.add(SNodeOperations.as(SLinkOperations.getTarget(node_ModuleImport_, "module", false), "com.mbeddr.cpp.cext.structure.CppImplementationModule"));
      }
    }


    return discoveredConcepts;

  }
}
